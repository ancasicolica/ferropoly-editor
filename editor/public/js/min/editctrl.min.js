/*! Ferropoly-Editor V2.5.1 16-04-2020, (c) Christian Kuster, CH-8342 Wernetshausen, christian@kusti.ch> */

"use strict";var editControl=angular.module("editApp",["ui.bootstrap","ui.sortable","ngSanitize","wiz.markdown"]);editControl.directive("convertToNumber",function(){return{require:"ngModel",link:function(scope,element,attrs,ngModel){ngModel.$parsers.push(function(val){return parseInt(val,10)});ngModel.$formatters.push(function(val){return""+val})}}});editControl.controller("editCtrl",["$scope","$http","$interval","$timeout",function($scope,$http,$interval,$timeout){$scope.panel="init";$scope.gameplay={};$scope.allProperties=[];$scope.markers=[];$scope.displayedProperties=[];$scope.gameplayReadOnly={};$scope.statusText="";$scope.currentMarker=undefined;$scope.propertyFilter="all";$scope.propertiesPredicate="data.location.name";$scope.reverse=false;$scope.nbPropertiesPerGroupOptions=[{name:"1",id:1},{name:"2",id:2},{name:"3",id:3},{name:"4",id:4}];$scope.numberOfPriceLevelsOptions=[{name:"1",id:1},{name:"2",id:2},{name:"3",id:3},{name:"4",id:4},{name:"5",id:5},{name:"6",id:6},{name:"7",id:7},{name:"8",id:8},{name:"9",id:9},{name:"10",id:10},{name:"11",id:11},{name:"12",id:12},{name:"14",id:14},{name:"15",id:15},{name:"16",id:16},{name:"20",id:20},{name:"24",id:24},{name:"25",id:25},{name:"30",id:30},{name:"32",id:32}];$scope.interestIntervalOptions=[{name:"15",id:15},{name:"20",id:20},{name:"30",id:30},{name:"60",id:60},{name:"90",id:90}];$scope.interestCyclesAtEndOfGameOptions=[{name:"0",id:0},{name:"1",id:1},{name:"2",id:2},{name:"3",id:3},{name:"4",id:4}];$scope.debtInterestOptions=[{name:"0",id:0},{name:"5",id:5},{name:"10",id:10},{name:"15",id:15},{name:"20",id:20}];var map=null;var authToken="none";var mapCenter=new google.maps.LatLng(0,0);var gameplayEditDateUpdatedCounter=-1;$scope.joinUrl=gameUrl+"/anmelden/"+gameId;$scope.priceRangeLists=[];$scope.sortableOptions=[];var initSortableOptions=function(){$scope.sortableOptions[0]={stop:function(){handleChangedPositionInPricelist($scope.priceRangeLists[0])}};$scope.sortableOptions[1]={stop:function(){handleChangedPositionInPricelist($scope.priceRangeLists[1])}};$scope.sortableOptions[2]={stop:function(){handleChangedPositionInPricelist($scope.priceRangeLists[2])}};$scope.sortableOptions[3]={stop:function(){handleChangedPositionInPricelist($scope.priceRangeLists[3])}};$scope.sortableOptions[4]={stop:function(){handleChangedPositionInPricelist($scope.priceRangeLists[4])}};$scope.sortableOptions[5]={stop:function(){handleChangedPositionInPricelist($scope.priceRangeLists[5])}}};var handleChangedPositionInPricelist=function(priceList){var pu=[];for(var i=0;i<priceList.length;i++){priceList[i].property.setPositionInPriceRange(i);var p=priceList[i].property.getPricelistPositionSaveSet();if(p){pu.push(p)}}console.log(pu);if(pu.length>0){$http.post("/gameplay/savePositionInPricelist/"+$scope.gameplay.internal.gameId,{authToken:authToken,properties:pu}).then(function(resp){console.log("Game saved");$scope.statusText=resp.data.message;updateEditDate()},function(resp){console.error("/gameplay/savePositionInPricelist/",resp);genericModals.showError("Fehler","Die Änderung konnte leider nicht gespeichert werden.",resp,function(){})})}};$scope.sortableOptionsClass0={stop:function(e,ui){handleChangedPositionInPricelist($scope.priceRangeLists.class0)}};$scope.sortableOptionsClass1={stop:function(e,ui){handleChangedPositionInPricelist($scope.priceRangeLists.class1)}};$scope.sortableOptionsClass2={stop:function(e,ui){handleChangedPositionInPricelist($scope.priceRangeLists.class2)}};$scope.sortableOptionsClass3={stop:function(e,ui){handleChangedPositionInPricelist($scope.priceRangeLists.class3)}};$scope.sortableOptionsClass4={stop:function(e,ui){handleChangedPositionInPricelist($scope.priceRangeLists.class4)}};$scope.sortableOptionsClass1={stop:function(e,ui){handleChangedPositionInPricelist($scope.priceRangeLists.class5)}};var setMapHeight=function(){var dh=$(window).height();var mc=document.querySelector("#map_canvas");var h=dh-95;mc.style.height=h.toString()+"px";google.maps.event.trigger(map,"resize");var locList=document.querySelector("#property-list");h=dh-110-$("#property-info").height()-$("#property-filter").height()-$("#property-list-header").height()-$("#ferropoly-navbar").height();locList.style.height=h.toString()+"px"};$scope.setCurrentProperty=function(marker){setCurrentProperty(marker);map.setCenter(marker.getPosition())};var setCurrentProperty=function(marker){if(!marker){return}if($scope.currentMarker&&$scope.currentMarker.property){$scope.currentMarker.property.setMarkerIcon(false)}marker.property.setMarkerIcon(true);$scope.currentMarker=marker;console.log(marker)};$scope.setVisibleMarkers=function(){console.log($scope.propertyFilter);$scope.displayedProperties=[];var mapToSet=null;var filter={priceRange:$scope.propertyFilter};for(var i=0;i<$scope.markers.length;i++){if($scope.markers[i].property.fitsFilterCriteria(filter)){mapToSet=map;$scope.displayedProperties.push($scope.markers[i].property)}else{mapToSet=null}if(mapToSet){if(!$scope.markers[i].map){$scope.markers[i].setMap(mapToSet)}}else{if($scope.markers[i].map){$scope.markers[i].setMap(null)}}}};var initPropertyMarkers=function(map,properties){var latSum=0;var lngSum=0;$scope.markers=[];for(var i=0;i<properties.length;i++){var newMarker=new google.maps.Marker({position:new google.maps.LatLng(properties[i].location.position.lat,properties[i].location.position.lng),map:map,draggable:false});latSum+=parseFloat(properties[i].location.position.lat);lngSum+=parseFloat(properties[i].location.position.lng);newMarker.property=new Property(properties[i]);newMarker.property.attachToMarker(newMarker);newMarker.property.setMarkerIcon();$scope.markers.push(newMarker);google.maps.event.addListener(newMarker,"click",function(newMarker){return function(){setCurrentProperty(newMarker);$scope.$apply()}}(newMarker))}setCurrentProperty($scope.markers[0]);$scope.setVisibleMarkers();mapCenter=new google.maps.LatLng(latSum/i,lngSum/i)};$scope.save=function(nextPanel){var gpToSave=_.cloneDeep($scope.gameplay);gpToSave.scheduling.gameStart=moment($scope.gameplay.scheduling.gameStart).format("HH:mm");gpToSave.scheduling.gameEnd=moment($scope.gameplay.scheduling.gameEnd).format("HH:mm");gpToSave.gameParams.properties.numberOfPriceLevels=$scope.numberOfPriceLevels;gpToSave.gameParams.properties.numberOfPropertiesPerGroup=$scope.numberOfPropertiesPerGroup;gpToSave.gameParams.interestInterval=$scope.interestInterval;gpToSave.gameParams.interestCyclesAtEndOfGame=$scope.interestCyclesAtEndOfGame;gpToSave.gameParams.debtInterest=$scope.debtInterest;gpToSave.gameParams.rentFactors.noHouse=$scope.noHouse;gpToSave.gameParams.rentFactors.oneHouse=$scope.oneHouse;gpToSave.gameParams.rentFactors.twoHouses=$scope.twoHouses;gpToSave.gameParams.rentFactors.threeHouses=$scope.threeHouses;gpToSave.gameParams.rentFactors.fourHouses=$scope.fourHouses;gpToSave.gameParams.rentFactors.hotel=$scope.hotel;gpToSave.gameParams.housePrices=$scope.housePrices;gpToSave.joining.possibleUntil=$scope.joiningPossibleUntil;$http.post("/gameplay/save/"+$scope.gameplay.internal.gameId,{gameplay:gpToSave,authToken:authToken}).then(function(){console.log("Game saved");$scope.statusText="Spiel gespeichert";if(nextPanel){$scope.panel=nextPanel;if(nextPanel==="map"){$scope.showMapTab()}}},function(resp){console.error("ERROR",resp);genericModals.showError("Fehler","Das Spiel konnte leider nicht gespeichert werden.",resp,function(){window.location.href="/"});fa.exception("Can not save game: "+resp.data.message)})};var updateEditDate=function(){gameplayEditDateUpdatedCounter++;if(gameplayEditDateUpdatedCounter%40>0){return}$http.post("/gameplay/dataChanged/"+$scope.gameplay.internal.gameId,{authToken:authToken}).then(function(){console.log("Game edit updated")},function(resp){console.error("/gameplay/dataChanged/ failed",resp)})};$scope.showMapTab=function(){$scope.panel="map";$timeout(function(){setMapHeight();console.log(mapCenter);map.setCenter(mapCenter)},250)};var extractPropertiesOfPriceRange=function(range){return _.sortBy(_.filter($scope.markers,function(p){return parseInt(p.property.data.pricelist.priceRange)===range}),function(n){return parseInt(n.property.data.pricelist.positionInPriceRange)})};$scope.showPriceList=function(){$scope.panel="pricelist";for(var i=0;i<6;i++){$scope.priceRangeLists[i]=extractPropertiesOfPriceRange(i);handleChangedPositionInPricelist($scope.priceRangeLists[i])}};$(document).ready(function(){initializeMap();initSortableOptions();$http.get("/authtoken").then(function(resp){authToken=resp.data.authToken;console.log("Auth ok");$http.get("/gameplay/load/"+gameId).then(function(resp){var data=resp.data;console.log("gameplay loaded",data);if(data.gameplay.internal.finalized){genericModals.showError("Fehler","Das Spiel ist bereits finalisiert, Du solltest das nicht sehen!",resp,function(){window.location.href="/"});return}$scope.gameplay=data.gameplay;$scope.allProperties=data.properties;$scope.gameplayReadOnly.created=moment($scope.gameplay.log.created).format("D.M.YY HH:mm");$scope.gameplayReadOnly.lastEdited=moment($scope.gameplay.log.lastEdited).format("D.M.YY HH:mm");$scope.gameplayReadOnly.map=$scope.gameplay.internal.map.toUpperCase();$scope.gameplayReadOnly.gameId=$scope.gameplay.internal.gameId;$scope.gameplayReadOnly.gamedate=moment($scope.gameplay.scheduling.gameDate).format("D.M.YY");$scope.gameplay.scheduling.gameStart=moment($scope.gameplay.scheduling.gameStart,"H:mm").toDate();$scope.gameplay.scheduling.gameEnd=moment($scope.gameplay.scheduling.gameEnd,"H:mm").toDate();$scope.numberOfPriceLevels=$scope.gameplay.gameParams.properties.numberOfPriceLevels;$scope.numberOfPropertiesPerGroup=$scope.gameplay.gameParams.properties.numberOfPropertiesPerGroup;$scope.interestInterval=$scope.gameplay.gameParams.interestInterval;$scope.interestCyclesAtEndOfGame=$scope.gameplay.gameParams.interestCyclesAtEndOfGame;$scope.debtInterest=$scope.gameplay.gameParams.debtInterest;$scope.noHouse=$scope.gameplay.gameParams.rentFactors.noHouse;$scope.oneHouse=$scope.gameplay.gameParams.rentFactors.oneHouse;$scope.twoHouses=$scope.gameplay.gameParams.rentFactors.twoHouses;$scope.threeHouses=$scope.gameplay.gameParams.rentFactors.threeHouses;$scope.fourHouses=$scope.gameplay.gameParams.rentFactors.fourHouses;$scope.hotel=$scope.gameplay.gameParams.rentFactors.hotel;$scope.housePrices=$scope.gameplay.gameParams.housePrices;$scope.joiningPossibleUntil=new Date($scope.gameplay.joining.possibleUntil);$scope.panel="gameplay";$scope.statusText="Spiel geladen";console.log($scope.gameplay);initPropertyMarkers(map,$scope.allProperties)},function(resp){console.error("/gameplay/load",resp);genericModals.showError("Fehler","Fehler beim Laden des Spiels",resp,function(){window.location.href="/"})})},function(data,status){console.log("authtoken failed",resp);genericModals.showError("Fehler","Bitte neu einloggen.",resp,function(){window.location.href="/"})})});var initializeMap=function(){map=new google.maps.Map(document.getElementById("map_canvas"),{center:new google.maps.LatLng(47.29725,8.867215),zoom:10,mapTypeId:google.maps.MapTypeId.ROADMAP});$(window).resize(setMapHeight);setMapHeight()};$scope.currentPropertyChanged=function(){if(!$scope.currentMarker||!$scope.currentMarker.property){console.log("Can not save, no marker or property");return}$scope.currentMarker.property.setPositionInPriceRange(-1);$http.post("/gameplay/saveProperty/"+$scope.gameplay.internal.gameId,{property:$scope.currentMarker.property.data,authToken:authToken}).then(function(resp){console.log("Game saved");$scope.statusText=resp.data.message;$scope.setVisibleMarkers();updateEditDate()},function(resp){console.error("/gameplay/saveProperty/ failed",resp);genericModals.showError("Fehler","Leider trat beim Speichern der Änderung ein Fehler auf.",resp,function(){window.location.href="/"})})};$scope.currentLocationAccessibility=function(){if(!$scope.currentMarker||!$scope.currentMarker.property){return"n/a"}return $scope.currentMarker.property.getAccessibilityText()};$scope.getGameDuration=function(){if($scope.gameplay&&$scope.gameplay.scheduling){return moment($scope.gameplay.scheduling.gameEnd).diff(moment($scope.gameplay.scheduling.gameStart),"minutes")}return 0};$scope.gameDurationValid=function(){return $scope.getGameDuration()>=4};$scope.propertyGroupsValid=function(){if(!$scope.gameplay.gameParams){return false}return $scope.getNumberOfProperties()%$scope.gameplay.gameParams.properties.numberOfPropertiesPerGroup===0};$scope.getNumberOfProperties=function(){return _.filter($scope.markers,function(p){return parseInt(p.property.data.pricelist.priceRange)>=0}).length};$scope.gameplayValid=function(){return $scope.gameDurationValid()&&$scope.getNumberOfProperties()>19&&$scope.propertyGroupsValid()};$scope.generatePricelist=function(){$http.post("/pricelist/create",{gameId:$scope.gameplay.internal.gameId,authToken:authToken}).then(function(resp){console.log("pricelist created");$scope.statusText=resp.data.message;self.location="/pricelist/view/"+resp.data.gameId;fa.event("Pricelist","created",$scope.gameplay.internal.gameId)},function(resp){console.error("/pricelist/create failed",resp);genericModals.showError("Fehler","Die Preisliste konnte nicht erstellt werden.",resp,function(){});a.exception("Can not create pricelist: "+resp.data.message)})};var numericControls=[{id:"#noHouse",name:"noHouse"},{id:"#oneHouse",name:"oneHouse"},{id:"#twoHouses",name:"twoHouses"},{id:"#threeHouses",name:"threeHouses"},{id:"#fourHouses",name:"fourHouses"},{id:"#hotel",name:"hotel"},{id:"#housePrices",name:"housePrices"},{id:"#lowestPrice",name:"gameplay.gameParams.properties.lowestPrice"},{id:"#highestPrice",name:"gameplay.gameParams.properties.highestPrice"},{id:"#interest",name:"gameplay.gameParams.interest"},{id:"#startCapital",name:"gameplay.gameParams.startCapital"}];function numericControlCorrection(controls){controls.forEach(function(control){$(control.id).focusout(function(){if(!$scope[control.name]){$scope[control.name]=parseFloat($(control.id).val());console.info('Undefined value corrected for "'+control.name+'" :'+$scope[control.name])}})})}numericControlCorrection(numericControls)}]);