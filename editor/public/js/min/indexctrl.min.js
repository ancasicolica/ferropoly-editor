/*! Ferropoly-Editor V2.4.4 06-09-2018, (c) Christian Kuster, CH-8342 Wernetshausen, christian@kusti.ch> */

"use strict";var indexControl=angular.module("indexApp",["ui.bootstrap"]);indexControl.controller("indexCtrl",["$scope","$http",function($scope,$http){$scope.gameplays=[];var authToken=undefined;$scope.gameplayToDelete=undefined;if(moment().hour()<4){$scope.intro="Hallo"}else if(moment().hour()<10){$scope.intro="Guten Morgen"}else if(moment().hour()<17){$scope.intro="Hallo"}else{$scope.intro="Guten Abend"}var getAuthToken=function(){$http.get("/authtoken").then(function(data){authToken=data.authToken;console.log("Auth ok")},function(data,status){console.log("error:");console.log(data);console.log(status);$scope.panel="error";$scope.errorMessage="Authentisierungsfehler. Status: "+status})};$scope.acceptAgb=function(){$http({method:"POST",url:"/agb/accept"}).then(function(){$scope.agb.accepted=true},function(resp){console.error(resp)})};$scope.declineAgb=function(){$http({method:"POST",url:"/logout"}).then(function(){console.log("logged out");window.location.replace("/")},function(resp){console.error(resp)})};$(document).ready(function(){var index=moment().hours()%6;$("#info-header").css("background-image",'url("/images/ferropoly_header_0'+index+'.jpg")');$http({method:"GET",url:"/agb"}).then(function(resp){console.log(resp);$scope.agb=resp.data.info;if($scope.agb.actionRequired){$("#agb-trigger").click()}},function(resp){console.error("/agb failed",resp)});$http({method:"GET",url:"/gameplay/mygames"}).then(function(resp){console.log(resp);$scope.gameplays=resp.data.gameplays;console.log("Gameplays loaded, nb:"+$scope.gameplays.length);$scope.gameplays.forEach(function(gp){var d=new Date(gp.log.lastEdited);console.log(gp)});getAuthToken()},function(resp){console.error("/gameplay/mygames",resp);$scope.gameplays=[];genericModals.showError("Fehler","Die Spiele konnten nicht geladen werden.",resp,function(){window.location.href="/"})})});$scope.prepareToDelete=function(obj){$scope.gameplayToDelete=obj.gameplay};$scope.notAllowedToDeleteGameplay=function(gameplay){return gameplay.internal.finalized&&moment(gameplay.scheduling.gameDate).startOf("day").isSame(moment().startOf("day"))||gameplay.internal.gameId==="play-a-demo-game"||!gameplay.isOwner};$scope.deleteGameplay=function(){if(!$scope.gameplayToDelete){console.log("no gameplay to delete");return}$http.delete("/gameplay/"+$scope.gameplayToDelete.internal.gameId,{authToken:authToken}).then(function(resp){console.log("gameplay deleted",resp.data);_.remove($scope.gameplays,function(gp){return gp.internal.gameId===$scope.gameplayToDelete.internal.gameId});$scope.statusText="Spiel gelöscht: "+$scope.gameplayToDelete.gamename;fa.event("Gameplay","deleted",$scope.gameplayToDelete.internal.gameId);$scope.gameplayToDelete=null},function(resp){console.log("/gameplay/delete failed",resp);genericModals.showError("Fehler","Spiel konnte nicht gelöscht werden.",resp);$scope.statusText="Spiel konnte nicht gelöscht werden: "+$scope.gameplayToDelete.gamename;fa.exception("Can not delete gameplay:"+resp.data.message);$scope.gameplayToDelete=null})}}]);