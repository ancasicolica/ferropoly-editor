/*! Ferropoly-Editor V1.105.0 17-04-2016, (c) Christian Kuster, CH-8342 Wernetshausen, christian@kusti.ch> */
"use strict";var indexControl=angular.module("indexApp",["ui.bootstrap"]);indexControl.controller("indexCtrl",["$scope","$http",function($scope,$http){$scope.gameplays=[];var authToken;$scope.gameplayToDelete;if(moment().hour()<4){$scope.intro="Hallo"}else if(moment().hour()<10){$scope.intro="Guten Morgen"}else if(moment().hour()<17){$scope.intro="Hallo"}else{$scope.intro="Guten Abend"}var getAuthToken=function(){$http.get("/authtoken").success(function(data){authToken=data.authToken;console.log("Auth ok")}).error(function(data,status){console.log("error:");console.log(data);console.log(status);$scope.panel="error";$scope.errorMessage="Authentisierungsfehler. Status: "+status})};$(document).ready(function(){var index=moment().hours()%6;$("#info-header").css("background-image",'url("/images/ferropoly_header_0'+index+'.jpg")');$http.get("/gameplay/mygames").success(function(data){if(data.success){$scope.gameplays=data.gameplays}else{$scope.gameplays=[]}console.log(data);console.log("Gameplays loaded, nb:"+$scope.gameplays.length);$scope.gameplays.forEach(function(gp){var d=new Date(gp.log.lastEdited);console.log(d);console.log(gp.log.lastEdited)});getAuthToken()}).error(function(data,status){console.log("error:");console.log(data);console.log(status);$scope.gameplays=[]})});$scope.prepareToDelete=function(obj){$scope.gameplayToDelete=obj.gameplay};$scope.notAllowedToDeleteGameplay=function(gameplay){console.log(gameplay);return gameplay.internal.finalized&&moment(gameplay.scheduling.gameDate).startOf("day").isSame(moment().startOf("day"))||gameplay.internal.gameId==="play-a-demo-game"};$scope.deleteGameplay=function(){if(!$scope.gameplayToDelete){console.log("no gameplay to delete");return}$http.post("/gameplay/delete",{gameId:$scope.gameplayToDelete.internal.gameId,authToken:authToken}).success(function(data){if(data.success){console.log("gameplay deleted");console.log(data);_.remove($scope.gameplays,function(gp){return gp.internal.gameId===$scope.gameplayToDelete.internal.gameId});$scope.statusText="Spiel gelöscht: "+$scope.gameplayToDelete.gamename;fa.event("Gameplay","deleted",$scope.gameplayToDelete.internal.gameId);$scope.gameplayToDelete=null}else{console.log("Error");console.log(data);$scope.statusText="Spiel konnte nicht gelöscht werden: "+$scope.gameplayToDelete.gamename;fa.exception("Can not delete gameplay:"+data.message);$scope.gameplayToDelete=null}}).error(function(data,status){console.log("ERROR");console.log(data);console.log(status);$scope.statusText="Spiel konnte nicht gelöscht werden: "+$scope.gameplayToDelete.gamename;fa.exception("Can not delete gameplay:"+data.message);$scope.gameplayToDelete=null})}}]);