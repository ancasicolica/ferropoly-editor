"use strict";var editControl=angular.module("editApp",["ui.bootstrap","ui.sortable"]);editControl.controller("editCtrl",["$scope","$http","$interval","$timeout",function(a,b,c,d){a.panel="init",a.errorMessage="",a.gameplay={},a.allProperties=[],a.markers=[],a.displayedProperties=[],a.gameplayReadOnly={},a.statusText="",a.currentMarker=void 0,a.propertyFilter="all",a.propertiesPredicate="data.location.name",a.reverse=!1;var e=null,f="none",g=new google.maps.LatLng(0,0),h=-1;a.priceRangeLists=[],a.sortableOptions=[];var i=function(){a.sortableOptions[0]={stop:function(){j(a.priceRangeLists[0])}},a.sortableOptions[1]={stop:function(){j(a.priceRangeLists[1])}},a.sortableOptions[2]={stop:function(){j(a.priceRangeLists[2])}},a.sortableOptions[3]={stop:function(){j(a.priceRangeLists[3])}},a.sortableOptions[4]={stop:function(){j(a.priceRangeLists[4])}},a.sortableOptions[5]={stop:function(){j(a.priceRangeLists[5])}}},j=function(c){for(var d=[],e=0;e<c.length;e++){c[e].property.setPositionInPriceRange(e);var g=c[e].property.getPricelistPositionSaveSet();g&&d.push(g)}console.log(d),d.length>0&&b.post("/edit/savePositionInPricelist",{gameId:a.gameplay.internal.gameId,authToken:f,properties:d}).success(function(b){b.success?(console.log("Game saved"),a.statusText=b.message,n()):(console.log("Error"),console.log(b),a.statusText="Fehler beim Speichern: "+b.message)}).error(function(b,c){console.log("ERROR"),console.log(b),console.log(c),a.statusText="Fehler beim Speichern: "+b.message})};a.sortableOptionsClass0={stop:function(){j(a.priceRangeLists.class0)}},a.sortableOptionsClass1={stop:function(){j(a.priceRangeLists.class1)}},a.sortableOptionsClass2={stop:function(){j(a.priceRangeLists.class2)}},a.sortableOptionsClass3={stop:function(){j(a.priceRangeLists.class3)}},a.sortableOptionsClass4={stop:function(){j(a.priceRangeLists.class4)}},a.sortableOptionsClass1={stop:function(){j(a.priceRangeLists.class5)}};var k=function(){var a=$(window).height(),b=document.querySelector("#map_canvas"),c=a-95;b.style.height=c.toString()+"px",google.maps.event.trigger(e,"resize");var d=document.querySelector("#property-list");c=a-110-$("#property-info").height()-$("#property-filter").height()-$("#property-list-header").height()-$("#ferropoly-navbar").height(),d.style.height=c.toString()+"px"};a.setCurrentProperty=function(a){l(a)};var l=function(b){b&&(a.currentMarker&&a.currentMarker.property&&a.currentMarker.property.setMarkerIcon(!1),b.property.setMarkerIcon(!0),a.currentMarker=b)};a.setVisibleMarkers=function(){console.log(a.propertyFilter),a.displayedProperties=[];for(var b=null,c={priceRange:a.propertyFilter},d=0;d<a.markers.length;d++)a.markers[d].property.fitsFilterCriteria(c)?(b=e,a.displayedProperties.push(a.markers[d].property)):b=null,b?a.markers[d].map||a.markers[d].setMap(b):a.markers[d].map&&a.markers[d].setMap(null)};var m=function(b,c){var d=0,e=0;a.markers=[];for(var f=0;f<c.length;f++){var h=new google.maps.Marker({position:new google.maps.LatLng(c[f].location.position.lat,c[f].location.position.lng),map:b,draggable:!1});d+=parseFloat(c[f].location.position.lat),e+=parseFloat(c[f].location.position.lng),h.property=new Property(c[f]),h.property.attachToMarker(h),h.property.setMarkerIcon(),a.markers.push(h),google.maps.event.addListener(h,"click",function(b){return function(){l(b),a.$apply()}}(h))}l(a.markers[0]),a.setVisibleMarkers(),g=new google.maps.LatLng(d/f,e/f)};a.save=function(c){b.post("/edit/save",{gameplay:a.gameplay,authToken:f}).success(function(b){b.success?(console.log("Game saved"),a.statusText="Spiel gespeichert",c&&(a.panel=c)):(console.log("Error"),console.log(b),a.errorMessage="Leider trat ein Fehler auf, Info:"+b.message,a.statusText="Fehler beim Speichern: "+b.message)}).error(function(b,c){console.log("ERROR"),console.log(b),console.log(c),a.errorMessage="Leider trat ein Fehler auf: Status:"+c+", Info:"+b.message,a.statusText="Fehler beim Speichern: "+b.message})};var n=function(){h++,h%40>0||b.post("/edit/dataChanged",{gameId:a.gameplay.internal.gameId,authToken:f}).success(function(a){a.success?console.log("Game edit updated"):(console.log("Error"),console.log(a))}).error(function(a,b){console.log("ERROR"),console.log(a),console.log(b)})};a.showMapTab=function(){a.panel="map",d(function(){k(),console.log(g),e.setCenter(g)},250)};var o=function(b){return _.sortBy(_.filter(a.markers,function(a){return parseInt(a.property.data.pricelist.priceRange)===b}),function(a){return parseInt(a.property.data.pricelist.positionInPriceRange)})};a.showPriceList=function(){a.panel="pricelist";for(var b=0;6>b;b++)a.priceRangeLists[b]=o(b),j(a.priceRangeLists[b])},$(document).ready(function(){p(),i(),b.get("/authtoken").success(function(c){f=c.authToken,console.log("Auth ok"),b.get("/edit/load-game?gameId="+gameId).success(function(b){return console.log(b),b.success?b.gameplay.internal.finalized?(a.panel="error",void(a.errorMessage="Das Spiel wurde schon finalisiert, Du solltest eigentlich gar nicht hier sein.")):(a.gameplay=b.gameplay,a.allProperties=b.properties,a.gameplayReadOnly.created=new Date(a.gameplay.log.created).toString("d.M.yy HH:mm"),a.gameplayReadOnly.lastEdited=new Date(a.gameplay.log.lastEdited).toString("d.M.yy HH:mm"),a.gameplayReadOnly.map=a.gameplay.internal.map.toUpperCase(),a.gameplayReadOnly.gameId=a.gameplay.internal.gameId,a.gameplayReadOnly.gamedate=new Date(a.gameplay.scheduling.gameStart).toString("d.M.yy"),a.panel="gameplay",a.statusText="Spiel geladen",void m(e,a.allProperties)):(a.panel="error",void(a.errorMessage="Der Server liefert folgende Antwort: "+b.message))}).error(function(b,c){console.log("load-game-error"),console.log(b),console.log(c),a.panel="error",a.errorMessage="Ladefehler, das Spiel kann nicht bearbeitet werden. Status: "+c})}).error(function(b,c){console.log("error:"),console.log(b),console.log(c),a.panel="error",a.errorMessage="Authentisierungsfehler, das Spiel kann nicht bearbeitet werden. Status: "+c})});var p=function(){e=new google.maps.Map(document.getElementById("map_canvas"),{center:new google.maps.LatLng(47.29725,8.867215),zoom:10,mapTypeId:google.maps.MapTypeId.ROADMAP}),$(window).resize(k),k()};a.currentPropertyChanged=function(){return a.currentMarker&&a.currentMarker.property?(a.currentMarker.property.setPositionInPriceRange(-1),void b.post("/edit/saveProperty",{property:a.currentMarker.property.data,authToken:f}).success(function(b){b.success?(console.log("Game saved"),a.statusText=b.message,a.setVisibleMarkers(),n()):(console.log("Error"),console.log(b),a.errorMessage="Leider trat ein Fehler auf, Info:"+b.message,a.statusText="Fehler beim Speichern: "+b.message)}).error(function(b,c){console.log("ERROR"),console.log(b),console.log(c),a.errorMessage="Leider trat ein Fehler auf: Status:"+c+", Info:"+b.message,a.statusText="Fehler beim Speichern: "+b.message})):void console.log("Can not save, no marker or property")},a.currentLocationAccessibility=function(){return a.currentMarker&&a.currentMarker.property?a.currentMarker.property.getAccessibilityText():"n/a"},a.getGameDuration=function(){if(a.gameplay&&a.gameplay.scheduling){var b=Date.parse(a.gameplay.scheduling.gameStart).getTime(),c=Date.parse(a.gameplay.scheduling.gameEnd).getTime();return(c-b)/60/1e3}return 0},a.gameDurationValid=function(){return a.getGameDuration()>=4},a.propertyGroupsValid=function(){return a.getNumberOfProperties()%a.gameplay.gameParams.properties.numberOfPropertiesPerGroup===0},a.getNumberOfProperties=function(){return _.filter(a.markers,function(a){return parseInt(a.property.data.pricelist.priceRange)>=0}).length},a.gameplayValid=function(){return a.gameDurationValid()&&a.getNumberOfProperties()>19&&a.propertyGroupsValid()},a.generatePricelist=function(){b.post("/pricelist/create",{gameId:a.gameplay.internal.gameId,authToken:f}).success(function(b){b.success?(console.log("pricelist created"),a.statusText=b.message,self.location="/pricelist?gameId="+b.gameId):(console.log("Error"),console.log(b))}).error(function(a,b){console.log("ERROR"),console.log(a),console.log(b)})}}]);